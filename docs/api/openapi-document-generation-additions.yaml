# OpenAPI Specification Additions for Document Generation Feature
# Version: 1.0
# Date: 2025-10-13
#
# This file contains complete OpenAPI 3.1.0 definitions to be added to openapi.locked.yaml
# for the Case Documentation Generation and Closure feature (FR-CM-006)
#
# INSTRUCTIONS FOR INTEGRATION:
# 1. Add the 4 path definitions to the 'paths:' section
# 2. Add the 7 schema definitions to 'components.schemas:' section
# 3. Update existing CaseStatus enum to include 'documenting'
# 4. Update existing Case schema to include new fields
# 5. Update POST /api/v1/cases/{case_id}/queries with middleware behavior notes

# =============================================================================
# NEW PATH DEFINITIONS (4 endpoints)
# =============================================================================

paths:
  /api/v1/cases/{case_id}/reports:
    post:
      tags:
        - case_management
        - documentation
      summary: Generate Case Documentation Reports
      description: |
        Generate professional documentation (Incident Report, Runbook, Post-Mortem) for a resolved case.

        **State Transitions:**
        - If case in RESOLVED/RESOLVED_WITH_WORKAROUND/RESOLVED_BY_USER → transition to DOCUMENTING
        - If case in DOCUMENTING → regenerate reports (versioning)
        - Other states → reject with 400 error

        **Behavior:**
        - First request enters DOCUMENTING state (restricted input mode)
        - Generates requested reports using LLM with case context
        - Reports sanitized for PII before storage
        - Versioning: Users can regenerate up to 5 times
        - Each regeneration increments version number

        **Report Types:**
        - `incident_report`: Timeline, root cause, resolution, recommendations
        - `runbook`: Step-by-step reproduction and resolution procedures
        - `post_mortem`: Comprehensive retrospective with lessons learned

      operationId: generate_case_reports_api_v1_cases_case_id_reports_post
      parameters:
        - name: case_id
          in: path
          required: true
          schema:
            type: string
          description: Unique case identifier
        - name: session_id
          in: header
          required: true
          schema:
            type: string
          description: User session identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReportGenerationRequest'
            examples:
              single_report:
                summary: Generate single incident report
                value:
                  report_types: ["incident_report"]
              multiple_reports:
                summary: Generate all three report types
                value:
                  report_types: ["incident_report", "runbook", "post_mortem"]
      responses:
        '200':
          description: Reports generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportGenerationResponse'
              examples:
                success:
                  summary: Successful generation of two reports
                  value:
                    case_id: "case-abc123"
                    reports:
                      - report_id: "550e8400-e29b-41d4-a716-446655440000"
                        case_id: "case-abc123"
                        report_type: "incident_report"
                        title: "Incident Report: Database Connection Timeout"
                        content: "# Incident Report\n\n## Executive Summary..."
                        format: "markdown"
                        generation_status: "completed"
                        generated_at: "2025-10-13T10:30:00Z"
                        generation_time_ms: 12500
                        is_current: true
                        version: 1
                        linked_to_closure: false
                      - report_id: "660e8400-e29b-41d4-a716-446655440001"
                        case_id: "case-abc123"
                        report_type: "runbook"
                        title: "Runbook: Database Connection Timeout"
                        content: "# Runbook\n\n## Problem Description..."
                        format: "markdown"
                        generation_status: "completed"
                        generated_at: "2025-10-13T10:30:15Z"
                        generation_time_ms: 9200
                        is_current: true
                        version: 1
                        linked_to_closure: false
                    remaining_regenerations: 4
        '400':
          description: Invalid request or case state
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - invalid_case_state
                      - regeneration_limit_exceeded
                      - invalid_report_types
                  message:
                    type: string
                  details:
                    type: object
              examples:
                invalid_state:
                  summary: Case not in valid state
                  value:
                    error: "invalid_case_state"
                    message: "Cannot generate reports from in_progress state"
                    details:
                      current_state: "in_progress"
                      required_states: ["resolved", "resolved_with_workaround", "resolved_by_user", "documenting"]
                regeneration_limit:
                  summary: Maximum regenerations exceeded
                  value:
                    error: "regeneration_limit_exceeded"
                    message: "Maximum 5 regenerations allowed"
                    details:
                      current_count: 5
                      max_allowed: 5
        '404':
          description: Case not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'

    get:
      tags:
        - case_management
        - documentation
      summary: Get Case Reports
      description: |
        Retrieve generated reports for a case.

        **Default Behavior:**
        - Returns only the latest version of each report type (is_current=true)

        **With include_history=true:**
        - Returns all report versions for audit trail
        - Sorted by report_type and version descending

        **Use Cases:**
        - Preview reports before case closure
        - Access archived reports after closure
        - Review report regeneration history

      operationId: get_case_reports_api_v1_cases_case_id_reports_get
      parameters:
        - name: case_id
          in: path
          required: true
          schema:
            type: string
          description: Unique case identifier
        - name: session_id
          in: header
          required: true
          schema:
            type: string
          description: User session identifier
        - name: include_history
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Include all report versions (default returns only latest per type)
      responses:
        '200':
          description: Reports retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CaseReport'
              examples:
                latest_only:
                  summary: Latest version per report type
                  value:
                    - report_id: "550e8400-e29b-41d4-a716-446655440000"
                      case_id: "case-abc123"
                      report_type: "incident_report"
                      title: "Incident Report: Database Connection Timeout"
                      format: "markdown"
                      generation_status: "completed"
                      generated_at: "2025-10-13T11:45:00Z"
                      generation_time_ms: 13200
                      is_current: true
                      version: 2
                      linked_to_closure: false
                with_history:
                  summary: All versions including history
                  value:
                    - report_id: "550e8400-e29b-41d4-a716-446655440000"
                      report_type: "incident_report"
                      version: 2
                      is_current: true
                      generated_at: "2025-10-13T11:45:00Z"
                    - report_id: "550e8400-e29b-41d4-a716-446655440099"
                      report_type: "incident_report"
                      version: 1
                      is_current: false
                      generated_at: "2025-10-13T10:30:00Z"
        '404':
          description: Case not found or no reports exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'

  /api/v1/cases/{case_id}/reports/{report_id}/download:
    get:
      tags:
        - case_management
        - documentation
      summary: Download Case Report
      description: |
        Download a generated report in the specified format.

        **Supported Formats:**
        - `markdown`: Original Markdown file (default)
        - `pdf`: Generated PDF (requires conversion via weasyprint)

        **Behavior:**
        - Returns file as attachment with appropriate Content-Type
        - Filename format: `{report_type}_{case_id}_v{version}.{ext}`
        - PDF generation: Markdown → HTML → PDF with CSS styling
        - Reports remain downloadable for 90 days after case closure

      operationId: download_case_report_api_v1_cases_case_id_reports_report_id_download_get
      parameters:
        - name: case_id
          in: path
          required: true
          schema:
            type: string
          description: Unique case identifier
        - name: report_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Report identifier (UUID)
        - name: session_id
          in: header
          required: true
          schema:
            type: string
          description: User session identifier
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum: [markdown, pdf]
            default: markdown
          description: Output format for the report
      responses:
        '200':
          description: Report file download
          content:
            text/markdown:
              schema:
                type: string
                format: binary
              examples:
                markdown_file:
                  summary: Markdown report file
                  value: |
                    # Incident Report: Database Connection Timeout

                    ## Executive Summary
                    ...
            application/pdf:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
              description: "attachment; filename=\"incident_report_case-abc123_v2.md\""
        '404':
          description: Report not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
        '422':
          description: Validation error (invalid format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'

  /api/v1/cases/{case_id}/close:
    post:
      tags:
        - case_management
        - documentation
      summary: Close Case
      description: |
        Close a case and archive with optional final reports.

        **State Transitions:**
        - RESOLVED/RESOLVED_WITH_WORKAROUND/RESOLVED_BY_USER → CLOSED (direct)
        - DOCUMENTING → CLOSED (archives linked reports)

        **Behavior:**
        - If case in DOCUMENTING: Links latest reports to closure (linked_to_closure=true)
        - Transitions case to CLOSED terminal state
        - Archives case data for historical access
        - Reports remain downloadable for 90 days
        - Prevents further modifications to case

        **Context Boundary Enforcement:**
        - Closed cases cannot be reopened
        - New incidents require new case creation
        - Maintains investigation context purity

      operationId: close_case_api_v1_cases_case_id_close_post
      parameters:
        - name: case_id
          in: path
          required: true
          schema:
            type: string
          description: Unique case identifier
        - name: session_id
          in: header
          required: true
          schema:
            type: string
          description: User session identifier
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CaseClosureRequest'
            examples:
              with_note:
                summary: Close with closure note
                value:
                  closure_note: "Issue resolved after database connection pool increase. Monitoring for 24h before final closure."
              no_note:
                summary: Close without note
                value: {}
      responses:
        '200':
          description: Case closed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CaseClosureResponse'
              examples:
                with_reports:
                  summary: Case closed with archived reports
                  value:
                    case_id: "case-abc123"
                    closed_at: "2025-10-13T15:30:00Z"
                    archived_reports:
                      - report_id: "550e8400-e29b-41d4-a716-446655440000"
                        report_type: "incident_report"
                        version: 2
                        linked_to_closure: true
                      - report_id: "660e8400-e29b-41d4-a716-446655440001"
                        report_type: "runbook"
                        version: 1
                        linked_to_closure: true
                    download_available_until: "2026-01-11T15:30:00Z"
                without_reports:
                  summary: Case closed without generating reports
                  value:
                    case_id: "case-xyz789"
                    closed_at: "2025-10-13T15:30:00Z"
                    archived_reports: []
                    download_available_until: "2026-01-11T15:30:00Z"
        '400':
          description: Invalid case state for closure
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  message:
                    type: string
                  details:
                    type: object
              examples:
                invalid_state:
                  summary: Cannot close case in current state
                  value:
                    error: "invalid_case_state"
                    message: "Cannot close case in in_progress state"
                    details:
                      current_state: "in_progress"
                      allowed_states: ["resolved", "resolved_with_workaround", "resolved_by_user", "documenting"]
        '404':
          description: Case not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'

# =============================================================================
# NEW SCHEMA DEFINITIONS (7 schemas)
# =============================================================================

components:
  schemas:
    # ---------------------------------------------------------------------
    # Primary Report Entity
    # ---------------------------------------------------------------------
    CaseReport:
      type: object
      required:
        - report_id
        - case_id
        - report_type
        - title
        - content
        - generation_status
        - generated_at
        - generation_time_ms
        - is_current
        - version
      properties:
        report_id:
          type: string
          format: uuid
          description: Unique report identifier (UUID v4)
          example: "550e8400-e29b-41d4-a716-446655440000"
        case_id:
          type: string
          description: Foreign key to parent case
          example: "case-abc123"
        report_type:
          type: string
          enum:
            - incident_report
            - runbook
            - post_mortem
          description: Type of report generated
        title:
          type: string
          minLength: 10
          maxLength: 200
          description: Human-readable report title
          example: "Incident Report: Database Connection Timeout"
        content:
          type: string
          description: Full report content in Markdown format
          example: |
            # Incident Report

            ## Executive Summary
            A database connection timeout occurred in production...
        format:
          type: string
          enum: [markdown]
          default: markdown
          description: Content format (currently only markdown supported)
        generation_status:
          type: string
          enum:
            - generating
            - completed
            - failed
          description: Report generation status
        generated_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp of report generation
          example: "2025-10-13T10:30:00Z"
        generation_time_ms:
          type: integer
          minimum: 0
          maximum: 120000
          description: Time taken to generate report (milliseconds)
          example: 12500
        is_current:
          type: boolean
          description: Whether this is the latest version for this report_type
          example: true
        version:
          type: integer
          minimum: 1
          maximum: 5
          description: Version number (increments with each regeneration)
          example: 2
        linked_to_closure:
          type: boolean
          default: false
          description: Whether report was linked to case closure
          example: true
        metadata:
          type: object
          nullable: true
          description: Optional metadata (LLM model, tokens used, etc.)
          additionalProperties: true
          example:
            llm_model: "gpt-4"
            tokens_used: 3500
            context_length: 15000
      title: CaseReport
      description: Generated case documentation report (DR-005)

    # ---------------------------------------------------------------------
    # Request/Response Models for Report Generation
    # ---------------------------------------------------------------------
    ReportGenerationRequest:
      type: object
      required:
        - report_types
      properties:
        report_types:
          type: array
          items:
            type: string
            enum:
              - incident_report
              - runbook
              - post_mortem
          minItems: 1
          maxItems: 3
          description: Types of reports to generate (max 3)
          example: ["incident_report", "runbook"]
      title: ReportGenerationRequest
      description: Request to generate case documentation reports

    ReportGenerationResponse:
      type: object
      required:
        - case_id
        - reports
        - remaining_regenerations
      properties:
        case_id:
          type: string
          description: Case identifier
          example: "case-abc123"
        reports:
          type: array
          items:
            $ref: '#/components/schemas/CaseReport'
          description: Generated reports
        remaining_regenerations:
          type: integer
          minimum: 0
          maximum: 5
          description: Number of remaining regeneration attempts (max 5 total)
          example: 4
      title: ReportGenerationResponse
      description: Response containing generated reports

    # ---------------------------------------------------------------------
    # Request/Response Models for Case Closure
    # ---------------------------------------------------------------------
    CaseClosureRequest:
      type: object
      properties:
        closure_note:
          type: string
          nullable: true
          maxLength: 500
          description: Optional note explaining closure reason
          example: "Issue resolved after database connection pool increase."
      title: CaseClosureRequest
      description: Request to close a case

    CaseClosureResponse:
      type: object
      required:
        - case_id
        - closed_at
        - archived_reports
        - download_available_until
      properties:
        case_id:
          type: string
          description: Case identifier
          example: "case-abc123"
        closed_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp of case closure
          example: "2025-10-13T15:30:00Z"
        archived_reports:
          type: array
          items:
            $ref: '#/components/schemas/CaseReport'
          description: Reports linked to case closure (available for 90 days)
        download_available_until:
          type: string
          format: date-time
          description: Timestamp when archived reports expire (90 days from closure)
          example: "2026-01-11T15:30:00Z"
      title: CaseClosureResponse
      description: Response confirming case closure

    # ---------------------------------------------------------------------
    # Updated/Extended Enums and Models
    # ---------------------------------------------------------------------
    ReportType:
      type: string
      enum:
        - incident_report
        - runbook
        - post_mortem
      description: |
        Type of case documentation report:
        - `incident_report`: Timeline, root cause, resolution, recommendations (for management/compliance)
        - `runbook`: Step-by-step reproduction and resolution procedures (for operations team)
        - `post_mortem`: Comprehensive retrospective with lessons learned (for team learning)
      title: ReportType

    ReportStatus:
      type: string
      enum:
        - generating
        - completed
        - failed
      description: |
        Report generation status:
        - `generating`: Report generation in progress
        - `completed`: Report generated successfully
        - `failed`: Report generation failed (see error details)
      title: ReportStatus

# =============================================================================
# UPDATES TO EXISTING SCHEMAS
# =============================================================================

# NOTE: The following changes should be made to existing schemas in openapi.locked.yaml:

# 1. UPDATE CaseStatus enum to include 'documenting' state:
#
# CaseStatus:
#   type: string
#   enum:
#     # Active Investigation States
#     - opened
#     - in_progress
#     - waiting_for_user
#     - waiting_for_data
#     - waiting_for_confirmation
#
#     # Resolution States
#     - resolved
#     - resolved_with_workaround
#     - resolved_by_user
#
#     # Documentation State (NEW)
#     - documenting
#
#     # Termination States
#     - closed
#     - escalated
#     - abandoned
#   description: |
#     Case status in lifecycle:
#
#     Active states allow troubleshooting and investigation.
#     Resolution states indicate problem solved, awaiting documentation.
#     DOCUMENTING state: Restricted mode for report generation only.
#     Terminal states: No further actions allowed.

# 2. ADD new fields to Case schema:
#
# Case:
#   type: object
#   properties:
#     # ... existing fields (case_id, user_id, title, description, status, etc.) ...
#
#     # NEW FIELDS for document generation:
#     documenting_started_at:
#       type: string
#       format: date-time
#       nullable: true
#       description: Timestamp when case entered DOCUMENTING state
#       example: "2025-10-13T10:00:00Z"
#
#     report_generation_count:
#       type: integer
#       minimum: 0
#       maximum: 5
#       default: 0
#       description: Number of report generation requests (for rate limiting)
#       example: 2
#
#     max_report_regenerations:
#       type: integer
#       minimum: 1
#       maximum: 10
#       default: 5
#       description: Maximum allowed report regeneration attempts
#       example: 5

# =============================================================================
# MODIFIED ENDPOINT BEHAVIOR
# =============================================================================

# UPDATE: POST /api/v1/cases/{case_id}/queries
#
# Add middleware validation for DOCUMENTING state:
#
# Description addition:
#   """
#   Submit query to agent for troubleshooting assistance.
#
#   **DOCUMENTING State Restrictions:**
#   When case.status == "documenting", this endpoint enforces restricted input mode:
#
#   - **Allowed Intents**: generate_report, regenerate_report, close_case, download_report
#   - **Blocked Intents**: new_incident, data_upload, follow_up_question, troubleshooting
#
#   Blocked queries receive 400 error with guidance to:
#   1. Generate/download reports from current case
#   2. Close current case
#   3. Create new case for new incidents
#
#   This ensures investigation context purity and accurate documentation.
#   """
#
# New 400 response for DOCUMENTING state:
#
# responses:
#   '400':
#     description: Bad Request (including DOCUMENTING state restrictions)
#     content:
#       application/json:
#         schema:
#           type: object
#           properties:
#             error:
#               type: string
#               enum:
#                 - case_in_documenting_mode
#                 - invalid_request
#             message:
#               type: string
#             suggested_action:
#               type: string
#               enum:
#                 - create_new_case
#                 - generate_reports
#                 - close_case
#             available_actions:
#               type: array
#               items:
#                 type: string
#         examples:
#           documenting_mode_new_incident:
#             summary: New incident blocked in DOCUMENTING mode
#             value:
#               error: "case_in_documenting_mode"
#               message: "This case is in documentation mode. It looks like you're reporting a new incident. This case is currently being closed and cannot accept new investigations."
#               suggested_action: "create_new_case"
#               available_actions: ["generate_reports", "close_case"]
#
#           documenting_mode_data_upload:
#             summary: Data upload blocked in DOCUMENTING mode
#             value:
#               error: "case_in_documenting_mode"
#               message: "This case is in documentation mode. Additional data uploads are not accepted after resolution."
#               suggested_action: "close_case"
#               available_actions: ["generate_reports", "close_case"]

# =============================================================================
# VALIDATION AND TESTING
# =============================================================================

# After integration, validate the OpenAPI spec using:
#
#   npm install -g @openapitools/openapi-generator-cli
#   openapi-generator-cli validate -i docs/api/openapi.locked.yaml
#
# Generate client SDKs for testing:
#
#   openapi-generator-cli generate \
#     -i docs/api/openapi.locked.yaml \
#     -g typescript-axios \
#     -o faultmaven-copilot/src/api/generated
#
# Test cases to verify:
#   1. Generate reports from RESOLVED case
#   2. Regenerate reports in DOCUMENTING state
#   3. Block new queries in DOCUMENTING state
#   4. Close case with reports
#   5. Download reports in markdown and PDF formats
#   6. Verify 90-day download expiration

# =============================================================================
# IMPLEMENTATION NOTES
# =============================================================================

# Backend Service Requirements:
#   - ReportGenerationService (faultmaven/services/domain/report_service.py)
#   - CaseContextExtractor (faultmaven/core/context/extractor.py)
#   - DocumentingModeMiddleware (faultmaven/api/middleware/documenting_mode.py)
#   - PDF converter (weasyprint integration)
#   - Report storage (DB: metadata, S3/MinIO: content)

# Database Migrations:
#   - Add 'documenting' to case_status enum
#   - Add documenting_started_at, report_generation_count to cases table
#   - Create case_reports table (report_id PK, case_id FK, content, metadata)

# Frontend Requirements:
#   - ReportSelectionUI modal (React component)
#   - DocumentingStateBanner component
#   - ReportPreviewUI component
#   - File download handlers (markdown, PDF)

# Security Considerations:
#   - PII sanitization before report storage
#   - Rate limiting on report generation (5 max)
#   - Access control: only case owner can generate/download reports
#   - Report content size limits (max 1MB per report)
