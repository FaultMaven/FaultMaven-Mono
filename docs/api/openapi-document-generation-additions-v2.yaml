# OpenAPI Specification Additions for Document Generation Feature (V2)
# Version: 2.0 (Updated with Intelligent Runbook Recommendations)
# Date: 2025-10-14
#
# This file contains complete OpenAPI 3.1.0 definitions to be added to openapi.locked.yaml
# for the Case Documentation Generation and Closure feature (FR-CM-006)
#
# MAJOR UPDATES IN V2:
# 1. Added GET /report-recommendations endpoint for intelligent runbook suggestions
# 2. Enhanced data models to support dual-source runbooks (incident + document-driven)
# 3. Added similarity search and recommendation logic specifications
# 4. Updated frontend UI flow to handle existing runbook preview and reuse

# =============================================================================
# NEW PATH DEFINITIONS (5 endpoints - was 4)
# =============================================================================

paths:
  # =================================================================
  # NEW ENDPOINT: Intelligent Report Recommendations
  # =================================================================
  /api/v1/cases/{case_id}/report-recommendations:
    get:
      tags:
        - case_management
        - documentation
        - knowledge_base
      summary: Get Intelligent Report Recommendations
      description: |
        Get intelligent recommendations for which reports to generate for a resolved case.

        **Purpose**: Prevent duplicate runbook generation by checking for existing similar runbooks.

        **Returns:**
        - **Always Available**: Incident Report, Post-Mortem (unique per incident)
        - **Conditional**: Runbook (based on similarity search of existing runbooks)

        **Runbook Recommendation Logic:**
        - **â‰¥85% similarity**: Recommend reuse existing runbook (show existing, hide generation checkbox)
        - **70-84% similarity**: Offer choice (show both review existing OR generate new)
        - **<70% similarity**: Recommend generation (show generation checkbox only)

        **Dual-Source Runbook Support:**
        Searches BOTH runbook types for similarity:
        1. **Incident-Driven**: Generated from past incident resolutions
        2. **Document-Driven**: Generated from uploaded operational documentation

        **Performance Target**: < 500ms (includes vector similarity search)

        **Call Flow:**
        1. Case enters RESOLVED state
        2. Frontend calls this endpoint immediately
        3. Frontend displays EnhancedReportSelectionUI with smart recommendations
        4. User chooses to reuse existing or generate new

      operationId: get_report_recommendations_api_v1_cases_case_id_report_recommendations_get
      parameters:
        - name: case_id
          in: path
          required: true
          schema:
            type: string
          description: Unique case identifier
        - name: session_id
          in: header
          required: true
          schema:
            type: string
          description: User session identifier
      responses:
        '200':
          description: Recommendations retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportRecommendation'
              examples:
                high_similarity_reuse:
                  summary: High similarity - recommend reuse existing runbook
                  value:
                    case_id: "case-abc123"
                    available_for_generation:
                      - "incident_report"
                      - "post_mortem"
                    runbook_recommendation:
                      action: "reuse"
                      existing_runbook:
                        report_id: "550e8400-e29b-41d4-a716-446655440000"
                        case_id: "case-xyz789"
                        report_type: "runbook"
                        title: "Runbook: Database Connection Pool Exhaustion"
                        format: "markdown"
                        generation_status: "completed"
                        generated_at: "2025-09-15T14:20:00Z"
                        is_current: true
                        version: 1
                        metadata:
                          source: "incident_driven"
                          domain: "database"
                          tags: ["postgresql", "connection-pool", "performance"]
                      similarity_score: 0.92
                      reason: "Found existing runbook with 92% similarity. Recommend using existing runbook instead of generating new one."

                moderate_similarity_review:
                  summary: Moderate similarity - offer review or generate
                  value:
                    case_id: "case-abc123"
                    available_for_generation:
                      - "incident_report"
                      - "runbook"
                      - "post_mortem"
                    runbook_recommendation:
                      action: "review_or_generate"
                      existing_runbook:
                        report_id: "660e8400-e29b-41d4-a716-446655440001"
                        case_id: "doc-derived"
                        report_type: "runbook"
                        title: "Runbook: PostgreSQL Performance Troubleshooting"
                        metadata:
                          source: "document_driven"
                          document_title: "PostgreSQL Operations Guide"
                          domain: "database"
                      similarity_score: 0.78
                      reason: "Found similar runbook (78% match). Review existing runbook or generate new one if significantly different."

                no_similarity_generate:
                  summary: No similarity - recommend generation
                  value:
                    case_id: "case-abc123"
                    available_for_generation:
                      - "incident_report"
                      - "runbook"
                      - "post_mortem"
                    runbook_recommendation:
                      action: "generate"
                      existing_runbook: null
                      similarity_score: null
                      reason: "No similar runbooks found. Generate new runbook."
        '400':
          description: Invalid case state (not resolved)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  message:
                    type: string
              examples:
                invalid_state:
                  summary: Case not in resolved state
                  value:
                    error: "invalid_case_state"
                    message: "Cannot get report recommendations for case in in_progress state"
        '404':
          description: Case not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'

  # =================================================================
  # EXISTING ENDPOINTS (from v1) - Unchanged
  # =================================================================
  /api/v1/cases/{case_id}/reports:
    post:
      tags:
        - case_management
        - documentation
      summary: Generate Case Documentation Reports
      description: |
        Generate professional documentation (Incident Report, Runbook, Post-Mortem) for a resolved case.

        **State Transitions:**
        - If case in RESOLVED/RESOLVED_WITH_WORKAROUND/RESOLVED_BY_USER â†’ transition to DOCUMENTING
        - If case in DOCUMENTING â†’ regenerate reports (versioning)
        - Other states â†’ reject with 400 error

        **Runbook Generation:**
        - Uses LLM to generate runbook from case context
        - Automatically indexes in RunbookKnowledgeBase for future similarity search
        - Marks as source="incident_driven" for dual-source tracking

        **Report Types:**
        - `incident_report`: Timeline, root cause, resolution, recommendations
        - `runbook`: Step-by-step reproduction and resolution procedures
        - `post_mortem`: Comprehensive retrospective with lessons learned

      operationId: generate_case_reports_api_v1_cases_case_id_reports_post
      parameters:
        - name: case_id
          in: path
          required: true
          schema:
            type: string
        - name: session_id
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReportGenerationRequest'
      responses:
        '200':
          description: Reports generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportGenerationResponse'
        '400':
          description: Invalid request or case state
        '404':
          description: Case not found
        '422':
          description: Validation error

    get:
      tags:
        - case_management
        - documentation
      summary: Get Case Reports
      description: |
        Retrieve generated reports for a case.

        **Returns:**
        - Latest version per report type (default)
        - All versions if include_history=true

      operationId: get_case_reports_api_v1_cases_case_id_reports_get
      parameters:
        - name: case_id
          in: path
          required: true
          schema:
            type: string
        - name: session_id
          in: header
          required: true
          schema:
            type: string
        - name: include_history
          in: query
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Reports retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CaseReport'
        '404':
          description: Case not found

  /api/v1/cases/{case_id}/reports/{report_id}/download:
    get:
      tags:
        - case_management
        - documentation
      summary: Download Case Report
      description: |
        Download a generated report in specified format (markdown or PDF).

      operationId: download_case_report_api_v1_cases_case_id_reports_report_id_download_get
      parameters:
        - name: case_id
          in: path
          required: true
          schema:
            type: string
        - name: report_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: session_id
          in: header
          required: true
          schema:
            type: string
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum: [markdown, pdf]
            default: markdown
      responses:
        '200':
          description: Report file download
          content:
            text/markdown:
              schema:
                type: string
                format: binary
            application/pdf:
              schema:
                type: string
                format: binary
        '404':
          description: Report not found
        '422':
          description: Invalid format

  /api/v1/cases/{case_id}/close:
    post:
      tags:
        - case_management
        - documentation
      summary: Close Case
      description: |
        Close case and archive with optional reports.

        **Behavior:**
        - Links latest reports to closure
        - Transitions to CLOSED terminal state
        - Reports remain downloadable for 90 days

      operationId: close_case_api_v1_cases_case_id_close_post
      parameters:
        - name: case_id
          in: path
          required: true
          schema:
            type: string
        - name: session_id
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CaseClosureRequest'
      responses:
        '200':
          description: Case closed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CaseClosureResponse'
        '400':
          description: Invalid case state
        '404':
          description: Case not found

# =============================================================================
# NEW/UPDATED SCHEMA DEFINITIONS (10 schemas)
# =============================================================================

components:
  schemas:
    # =================================================================
    # NEW SCHEMAS: Intelligent Recommendations
    # =================================================================
    ReportRecommendation:
      type: object
      required:
        - case_id
        - available_for_generation
        - runbook_recommendation
      properties:
        case_id:
          type: string
          description: Case identifier
          example: "case-abc123"
        available_for_generation:
          type: array
          items:
            $ref: '#/components/schemas/ReportType'
          description: |
            Report types available for generation.
            - Always includes: incident_report, post_mortem
            - Conditionally includes: runbook (based on similarity search)
          example: ["incident_report", "runbook", "post_mortem"]
        runbook_recommendation:
          $ref: '#/components/schemas/RunbookRecommendation'
      title: ReportRecommendation
      description: Intelligent recommendations for report generation

    RunbookRecommendation:
      type: object
      required:
        - action
        - reason
      properties:
        action:
          type: string
          enum:
            - reuse
            - review_or_generate
            - generate
          description: |
            Recommended action:
            - `reuse`: High similarity (â‰¥85%), recommend using existing runbook
            - `review_or_generate`: Moderate similarity (70-84%), offer both options
            - `generate`: Low/no similarity (<70%), recommend generating new runbook
          example: "reuse"
        existing_runbook:
          allOf:
            - $ref: '#/components/schemas/CaseReport'
          nullable: true
          description: Existing similar runbook (if found)
        similarity_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
          description: Semantic similarity score (0.0-1.0)
          example: 0.92
        reason:
          type: string
          maxLength: 500
          description: Human-readable explanation of recommendation
          example: "Found existing runbook with 92% similarity. Recommend using existing runbook instead of generating new one."
      title: RunbookRecommendation
      description: Runbook-specific recommendation with similarity analysis

    SimilarRunbook:
      type: object
      required:
        - runbook
        - similarity_score
        - case_title
        - case_id
      properties:
        runbook:
          $ref: '#/components/schemas/CaseReport'
        similarity_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: Cosine similarity score from vector search
          example: 0.87
        case_title:
          type: string
          description: Title of case that generated this runbook (or document title)
          example: "Database Connection Pool Exhaustion"
        case_id:
          type: string
          description: Case ID (or 'doc-derived' for document-driven runbooks)
          example: "case-xyz789"
      title: SimilarRunbook
      description: Similar runbook search result from knowledge base

    # =================================================================
    # UPDATED SCHEMA: CaseReport (Enhanced for Dual-Source)
    # =================================================================
    CaseReport:
      type: object
      required:
        - report_id
        - case_id
        - report_type
        - title
        - content
        - generation_status
        - generated_at
        - generation_time_ms
        - is_current
        - version
      properties:
        report_id:
          type: string
          format: uuid
          description: Unique report identifier (UUID v4)
          example: "550e8400-e29b-41d4-a716-446655440000"
        case_id:
          type: string
          description: |
            Foreign key to parent case.
            - Incident-driven: actual case ID (e.g., "case-abc123")
            - Document-driven: special marker "doc-derived"
          example: "case-abc123"
        report_type:
          $ref: '#/components/schemas/ReportType'
        title:
          type: string
          minLength: 10
          maxLength: 200
          description: Human-readable report title
          example: "Runbook: Database Connection Timeout"
        content:
          type: string
          description: Full report content in Markdown format
          example: "# Runbook\n\n## Problem Description..."
        format:
          type: string
          enum: [markdown]
          default: markdown
        generation_status:
          $ref: '#/components/schemas/ReportStatus'
        generated_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: "2025-10-13T10:30:00Z"
        generation_time_ms:
          type: integer
          minimum: 0
          maximum: 120000
          description: Time taken to generate (milliseconds)
          example: 12500
        is_current:
          type: boolean
          description: Latest version for this report_type
          example: true
        version:
          type: integer
          minimum: 1
          maximum: 5
          example: 2
        linked_to_closure:
          type: boolean
          default: false
          description: Linked to case closure
          example: false
        metadata:
          $ref: '#/components/schemas/RunbookMetadata'
          nullable: true
      title: CaseReport
      description: |
        Generated case documentation report (DR-005).
        Supports DUAL runbook sources:
        - Incident-driven: Generated from case resolution
        - Document-driven: Generated from uploaded documentation

    RunbookMetadata:
      type: object
      required:
        - source
        - domain
      properties:
        source:
          type: string
          enum:
            - incident_driven
            - document_driven
          description: |
            Origin of runbook:
            - `incident_driven`: Generated from resolved incident (this document)
            - `document_driven`: Generated from uploaded operational docs (separate flow)
          example: "incident_driven"
        # For incident-driven runbooks
        case_context:
          type: object
          nullable: true
          description: Case investigation context (incident-driven only)
          additionalProperties: true
        # For document-driven runbooks
        document_title:
          type: string
          nullable: true
          description: Source document title (document-driven only)
          example: "PostgreSQL Operations Guide"
        original_document_id:
          type: string
          nullable: true
          format: uuid
          description: Reference to uploaded document (document-driven only)
        # Common metadata
        domain:
          type: string
          description: Technology domain for filtering
          example: "database"
        tags:
          type: array
          items:
            type: string
          description: Classification tags for similarity search
          example: ["postgresql", "connection-pool", "performance"]
        llm_model:
          type: string
          nullable: true
          description: LLM model used for generation
          example: "gpt-4"
        embedding_model:
          type: string
          nullable: true
          description: Embedding model for vector search
          example: "BAAI/bge-m3"
      title: RunbookMetadata
      description: |
        Metadata for runbook reports supporting dual sources.
        Tracks origin (incident vs document) for transparency.

    # =================================================================
    # EXISTING SCHEMAS (from v1) - Unchanged
    # =================================================================
    ReportType:
      type: string
      enum:
        - incident_report
        - runbook
        - post_mortem
      title: ReportType
      description: Type of case documentation report

    ReportStatus:
      type: string
      enum:
        - generating
        - completed
        - failed
      title: ReportStatus

    ReportGenerationRequest:
      type: object
      required:
        - report_types
      properties:
        report_types:
          type: array
          items:
            $ref: '#/components/schemas/ReportType'
          minItems: 1
          maxItems: 3
      title: ReportGenerationRequest

    ReportGenerationResponse:
      type: object
      required:
        - case_id
        - reports
        - remaining_regenerations
      properties:
        case_id:
          type: string
        reports:
          type: array
          items:
            $ref: '#/components/schemas/CaseReport'
        remaining_regenerations:
          type: integer
          minimum: 0
          maximum: 5
      title: ReportGenerationResponse

    CaseClosureRequest:
      type: object
      properties:
        closure_note:
          type: string
          nullable: true
          maxLength: 500
      title: CaseClosureRequest

    CaseClosureResponse:
      type: object
      required:
        - case_id
        - closed_at
        - archived_reports
        - download_available_until
      properties:
        case_id:
          type: string
        closed_at:
          type: string
          format: date-time
        archived_reports:
          type: array
          items:
            $ref: '#/components/schemas/CaseReport'
        download_available_until:
          type: string
          format: date-time
      title: CaseClosureResponse

# =============================================================================
# BACKEND SERVICE REQUIREMENTS
# =============================================================================

# NEW SERVICES REQUIRED:
#
# 1. ReportRecommendationService
#    Location: faultmaven/services/domain/report_recommendation_service.py
#    Purpose: Intelligent report recommendations with similarity search
#    Methods:
#      - get_available_report_types(case_id) -> ReportRecommendation
#      - _find_similar_runbooks(case) -> List[SimilarRunbook]
#      - _create_case_embedding(case) -> List[float]
#
# 2. RunbookKnowledgeBase
#    Location: faultmaven/infrastructure/knowledge/runbook_kb.py
#    Purpose: Vector similarity search for runbooks (dual-source)
#    Methods:
#      - search_runbooks(embedding, filters, top_k, min_similarity) -> List[SimilarRunbook]
#      - index_runbook(runbook, source: RunbookSource) -> None
#      - index_document_derived_runbook(...) -> str
#    Dependencies:
#      - ChromaDB vector store (existing)
#      - BGE-M3 embedding model (existing in knowledge base)
#
# 3. Enhanced ReportGenerationService
#    Location: faultmaven/services/domain/report_service.py (update existing)
#    New Methods:
#      - After generate_report() completes for runbook:
#        * Automatically call runbook_kb.index_runbook()
#        * Mark metadata.source = "incident_driven"
#
# 4. CaseContextExtractor (existing, may need minor updates)
#    Location: faultmaven/core/context/extractor.py
#    Purpose: Extract case features for similarity comparison

# =============================================================================
# CHROMADB INTEGRATION REQUIREMENTS
# =============================================================================

# Vector Store Schema:
#   Collection Name: "faultmaven_runbooks"
#   Embedding Model: BAAI/bge-m3 (1024 dimensions)
#   Distance Metric: Cosine similarity
#
# Document Schema:
#   - id: report_id (UUID)
#   - embedding: [float] (1024-dim vector)
#   - document: runbook content (markdown)
#   - metadata:
#       - report_id: UUID
#       - case_id: string (or "doc-derived")
#       - case_title: string
#       - report_type: "runbook"
#       - runbook_source: "incident_driven" | "document_driven"
#       - domain: string
#       - tags: List[string]
#       - created_at: ISO timestamp
#
# Queries:
#   - search_runbooks():
#       query_embeddings: case embedding
#       where: {"report_type": "runbook", "domain": case.domain}
#       n_results: 5
#       Returns: IDs, distances, metadatas

# =============================================================================
# FRONTEND UI UPDATES (Enhanced from v1)
# =============================================================================

# NEW COMPONENTS:
#
# 1. EnhancedReportSelectionUI (replaces ReportSelectionUI)
#    File: faultmaven-copilot/src/components/case/EnhancedReportSelectionUI.tsx
#    Props:
#      - recommendations: ReportRecommendation
#    Features:
#      - Shows existing runbook preview for high similarity
#      - Displays source badge (incident-driven vs document-driven)
#      - "View Existing Runbook" button
#      - Conditional runbook generation checkbox
#
# 2. ExistingRunbookPreviewDialog
#    File: faultmaven-copilot/src/components/case/ExistingRunbookPreviewDialog.tsx
#    Props:
#      - runbook: CaseReport
#      - similarityScore: number
#    Features:
#      - Full runbook content preview
#      - Metadata display (source, domain, tags, created date)
#      - "Use This Runbook" button
#      - "Generate New Instead" button
#
# 3. RunbookSourceBadge
#    File: faultmaven-copilot/src/components/case/RunbookSourceBadge.tsx
#    Props:
#      - source: "incident_driven" | "document_driven"
#    Display:
#      - incident_driven: "ðŸ”§ From Incident Resolution"
#      - document_driven: "ðŸ“„ From Documentation"

# =============================================================================
# INTEGRATION WORKFLOW (Incident-Driven)
# =============================================================================

# Happy Path Flow:
#
# 1. Case Resolution
#    - Agent/user marks case as RESOLVED
#    - Backend transitions to RESOLVED state
#
# 2. Get Recommendations (NEW STEP)
#    - Frontend: GET /cases/{id}/report-recommendations
#    - Backend:
#        a. Extract case features (problem, root cause, resolution)
#        b. Create embedding using BGE-M3
#        c. Query ChromaDB for similar runbooks (both sources)
#        d. Calculate similarity scores
#        e. Apply recommendation logic (â‰¥85%, 70-84%, <70%)
#        f. Return ReportRecommendation
#    - Performance: < 500ms
#
# 3. Display Smart UI
#    - Frontend renders EnhancedReportSelectionUI
#    - Shows existing runbook if high similarity
#    - Displays source badge and metadata
#    - User can preview existing runbook
#
# 4. User Decision
#    Option A: Use Existing Runbook (â‰¥85% similarity)
#      - User clicks "Use Existing Runbook"
#      - Frontend: POST /cases/{id}/reports with runbook reference
#      - Backend: Link existing runbook to case (no generation)
#
#    Option B: Generate New Runbook
#      - User selects runbook checkbox
#      - Frontend: POST /cases/{id}/reports
#      - Backend:
#          a. Generate runbook via LLM
#          b. Save to database
#          c. Index in ChromaDB (source="incident_driven")
#
# 5. Case Closure
#    - POST /cases/{id}/close
#    - Reports linked to closure

# =============================================================================
# PERFORMANCE TARGETS (Updated)
# =============================================================================

# Endpoint Performance:
#   - GET /report-recommendations: < 500ms (including vector search)
#   - POST /reports (generation): < 30 seconds per report
#   - GET /reports: < 200ms
#   - GET /reports/{id}/download: < 2 seconds
#   - POST /close: < 1 second
#
# Vector Search Performance:
#   - Embedding generation: < 100ms
#   - ChromaDB query: < 200ms (top-5 results)
#   - Total recommendation time: < 500ms
#
# Recommendation Accuracy:
#   - Precision at 85% threshold: > 90%
#   - Recall of similar runbooks: > 80%
#   - False positive rate: < 10%

# =============================================================================
# SUCCESS METRICS (Updated)
# =============================================================================

# Functional:
#   - Knowledge Reuse: 70%+ of similar incidents reuse existing runbooks
#   - Recommendation Accuracy: 90%+ precision at â‰¥85% threshold
#   - Duplicate Prevention: 50%+ reduction in redundant runbook generation
#
# Performance:
#   - Recommendation Latency: < 500ms (95th percentile)
#   - Generation Time: < 30 seconds per report
#   - Vector Search Accuracy: > 85% relevant results in top-5
#
# User Experience:
#   - Recommendation Clarity: 90%+ users understand suggestion
#   - Runbook Reuse Rate: 70%+ choose existing when offered
#   - Satisfaction: 85%+ find recommendations helpful

# =============================================================================
# TESTING STRATEGY (Updated with Recommendations)
# =============================================================================

# New Unit Tests:
#   - test_get_report_recommendations_high_similarity()
#   - test_get_report_recommendations_moderate_similarity()
#   - test_get_report_recommendations_no_similarity()
#   - test_find_similar_runbooks_incident_driven()
#   - test_find_similar_runbooks_document_driven()
#   - test_find_similar_runbooks_mixed_sources()
#   - test_create_case_embedding()
#   - test_similarity_scoring_accuracy()
#   - test_runbook_indexing_after_generation()
#
# New Integration Tests:
#   - test_recommendation_flow_high_similarity_reuse()
#   - test_recommendation_flow_moderate_similarity_generate()
#   - test_dual_source_runbook_search()
#   - test_runbook_indexing_and_retrieval()
#
# New Performance Tests:
#   - test_recommendation_latency_under_500ms()
#   - test_vector_search_performance()
#   - test_concurrent_recommendation_requests()

# =============================================================================
# DATABASE SCHEMA ADDITIONS (Updated)
# =============================================================================

# case_reports table (existing, minor update):
#   - Add: metadata JSONB column (if not exists)
#     * Stores RunbookMetadata structure
#     * Index on metadata->>'source' for filtering
#
# ChromaDB collection (new):
#   - Collection: faultmaven_runbooks
#   - Indexed fields: report_id, case_id, runbook_source, domain, tags
#
# No additional SQL tables needed - ChromaDB handles vector storage

# =============================================================================
# MIGRATION NOTES
# =============================================================================

# For existing runbooks (if any):
#   - Backfill metadata.source = "incident_driven" for all existing runbooks
#   - Re-index existing runbooks in ChromaDB
#   - Script: scripts/migrations/backfill_runbook_metadata.py
